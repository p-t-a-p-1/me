---
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import BlogSidebar from "../../components/BlogSidebar.astro";
import TableOfContents from "../../components/TableOfContents.astro";
import Layout from "../../layouts/Layout.astro";
import { formatDate } from "../../lib/utils";

export async function getStaticPaths() {
	const posts = await getCollection("blog");
	return posts.map((post) => ({
		params: { slug: post.slug },
		props: { post },
	}));
}

type Props = {
	post: CollectionEntry<"blog">;
};

const { post } = Astro.props;
const { Content, headings } = await post.render();

// Ë™≠‰∫ÜÊôÇÈñì„ÅÆË®àÁÆó
function calculateReadingTime(wordCount?: number): number {
	if (!wordCount || wordCount <= 0) {
		return 1; // „Éá„Éï„Ç©„É´„ÉàÂÄ§
	}
	const wordsPerMinute = 200; // Âπ≥ÂùáË™≠Êõ∏ÈÄüÂ∫¶
	return Math.ceil(wordCount / wordsPerMinute);
}

const readingTime =
	post.data.readingTime || calculateReadingTime(post.data.wordCount);
---

<Layout title={post.data.title}>
	<main class="blog-detail">
		<div class="blog-detail__container">
			<div class="blog-detail__content">
				<article class="blog-detail__article">
					<header class="blog-detail__header">
						<div class="blog-detail__emoji">{post.data.emoji || "üìù"}</div>
						<h1 class="blog-detail__title">{post.data.title}</h1>
						<div class="blog-detail__meta">
							<div class="blog-detail__dates">
								{
									post.data.publishedAt && (
										<time
											datetime={post.data.publishedAt.toISOString()}
											class="blog-detail__date"
										>
											ÂÖ¨ÈñãÊó•: {formatDate(post.data.publishedAt.toISOString())}
										</time>
									)
								}
								{
									readingTime && (
										<span class="blog-detail__reading-time">
											Ë™≠‰∫ÜÊôÇÈñì: Á¥Ñ{readingTime}ÂàÜ
										</span>
									)
								}
							</div>
							{
								post.data.tags && post.data.tags.length > 0 && (
									<div class="blog-detail__tags">
										{post.data.tags.map((tag) => (
											<span class="blog-detail__tag">#{tag}</span>
										))}
									</div>
								)
							}
						</div>
					</header>
					<TableOfContents headings={headings} />
					<div class="blog-detail__body">
						<Content />
					</div>
					<div class="blog-detail__back">
						<a href="/blog" class="blog-detail__back-link">
							<svg
								xmlns="http://www.w3.org/2000/svg"
								width="24"
								height="24"
								viewBox="0 0 24 24"
								fill="none"
								stroke="currentColor"
								stroke-width="2"
								stroke-linecap="round"
								stroke-linejoin="round"
							>
								<path d="M19 12H5M5 12L12 19M5 12L12 5"></path>
							</svg>
							<span>„Éñ„É≠„Ç∞‰∏ÄË¶ß„Å∏Êàª„Çã</span>
						</a>
					</div>
				</article>
			</div>
			<aside class="blog-detail__sidebar">
				<BlogSidebar />
			</aside>
		</div>
	</main>
</Layout>

<style>
	.blog-detail {
		padding: 40px 20px;
	}

	.blog-detail__container {
		max-width: 1200px;
		margin: 0 auto;
		display: grid;
		grid-template-columns: 1fr 300px;
		gap: 40px;
	}

	.blog-detail__content {
		overflow: hidden;
	}

	.blog-detail__article {
		background-color: #ffffff;
		padding: 40px;
		border: 1px solid #262626;
	}

	.blog-detail__sidebar {
		position: relative;
	}

	.blog-detail__header {
		margin-bottom: 40px;
		padding-bottom: 20px;
		border-bottom: 1px solid #e5e5e5;
	}

	.blog-detail__emoji {
		font-size: 48px;
		line-height: 1;
		margin-bottom: 16px;
		text-align: center;
	}

	.blog-detail__title {
		font-family: "Noto Sans JP", sans-serif;
		font-size: 32px;
		font-weight: 700;
		line-height: 1.4;
		color: #262626;
		margin: 0 0 16px;
		text-align: center;
	}

	.blog-detail__meta {
		display: flex;
		flex-direction: column;
		gap: 12px;
		align-items: center;
	}

	.blog-detail__dates {
		display: flex;
		gap: 16px;
		color: #8c8c8c;
		font-size: 14px;
	}

	.blog-detail__tags {
		display: flex;
		gap: 8px;
		flex-wrap: wrap;
		justify-content: center;
	}

	.blog-detail__tag {
		background-color: #f5f5f5;
		color: #262626;
		padding: 4px 8px;
		border-radius: 4px;
		font-size: 12px;
		font-weight: 500;
	}

	.blog-detail__body {
		line-height: 1.8;
		color: #262626;
	}

	.blog-detail__body :global(h1),
	.blog-detail__body :global(h2),
	.blog-detail__body :global(h3),
	.blog-detail__body :global(h4),
	.blog-detail__body :global(h5),
	.blog-detail__body :global(h6) {
		font-family: "Noto Sans JP", sans-serif;
		font-weight: 700;
		color: #262626;
		margin: 32px 0 16px;
	}

	.blog-detail__body :global(h1) {
		font-size: 28px;
	}

	.blog-detail__body :global(h2) {
		font-size: 24px;
	}

	.blog-detail__body :global(h3) {
		font-size: 20px;
	}

	.blog-detail__body :global(p) {
		margin: 16px 0;
	}

	.blog-detail__body :global(ul),
	.blog-detail__body :global(ol) {
		margin: 16px 0;
		padding-left: 24px;
	}

	.blog-detail__body :global(li) {
		margin: 8px 0;
	}

	.blog-detail__body :global(code) {
		background-color: #f5f5f5;
		padding: 2px 4px;
		border-radius: 3px;
		font-family:
			"SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
		font-size: 0.9em;
	}

	.blog-detail__body :global(pre) {
		background-color: #f5f5f5;
		padding: 16px;
		border-radius: 8px;
		overflow-x: auto;
		margin: 16px 0;
	}

	.blog-detail__body :global(pre code) {
		background: none;
		padding: 0;
	}

	.blog-detail__body :global(blockquote) {
		border-left: 4px solid #e5e5e5;
		padding-left: 16px;
		margin: 16px 0;
		color: #8c8c8c;
		font-style: italic;
	}

	.blog-detail__body :global(a) {
		color: #0066cc;
		text-decoration: underline;
	}

	.blog-detail__body :global(a:hover) {
		color: #004499;
	}

	.blog-detail__back {
		margin-top: 40px;
		text-align: center;
	}

	.blog-detail__back-link {
		display: inline-flex;
		align-items: center;
		gap: 8px;
		color: #262626;
		text-decoration: none;
		padding: 12px 24px;
		border: 1px solid #262626;
		background-color: #ffffff;
		transition: all 0.2s ease;
	}

	.blog-detail__back-link:hover {
		background-color: #262626;
		color: #ffffff;
	}

	@media (max-width: 768px) {
		.blog-detail {
			padding: 20px 10px;
		}

		.blog-detail__container {
			grid-template-columns: 1fr;
			gap: 20px;
		}

		.blog-detail__sidebar {
			order: -1;
		}

		.blog-detail__article {
			padding: 20px;
		}

		.blog-detail__title {
			font-size: 24px;
		}

		.blog-detail__emoji {
			font-size: 36px;
		}

		.blog-detail__dates {
			flex-direction: column;
			gap: 8px;
		}
	}
</style>
